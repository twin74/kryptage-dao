{"language":"Solidity","sources":{"StableController.sol":{"content":"// SPDX-License-Identifier: MIT\npragma solidity ^0.8.23;\n\ninterface IERC20 {\n    function transferFrom(address from, address to, uint256 amount) external returns (bool);\n    function transfer(address to, uint256 amount) external returns (bool);\n    function approve(address spender, uint256 amount) external returns (bool);\n}\n\ninterface IStableFarm {\n    function stake(uint256 amount) external;\n    function unstake(uint256 amount) external;\n    function pendingRewards() external view returns (uint256);\n    function compound() external;\n    function claim() external returns (uint256);\n}\n\ninterface IUSDK {\n    function mint(address to, uint256 amount) external;\n    function burn(address from, uint256 amount) external;\n}\n\ninterface IStableVault {\n    function mintShares(address to, uint256 amount) external;\n    function burnShares(address from, uint256 amount) external;\n    function depositUSDK(uint256 amount) external;\n    function redeemUSDK(address to, uint256 shares) external;\n}\n\ncontract StableController {\n    IERC20 public usdc;\n    IUSDK public usdk;\n    IStableFarm public farm;\n    IStableVault public vault;\n\n    bool private initialized;\n    address public owner;\n\n    // Security\n    bool public paused;\n    bool private reentrancyLock;\n\n    event Deposited(address indexed user, uint256 usdcAmount, uint256 sharesMinted);\n    event Harvested(uint256 rewardUSDK, uint256 mintedUSDK, uint256 ktgPoints);\n    event Compounded(uint256 timestamp, uint256 amount);\n    event Withdrawn(address indexed user, uint256 sharesBurned, uint256 usdkOut);\n    event Paused(address indexed by);\n    event Unpaused(address indexed by);\n    event OwnerChanged(address indexed oldOwner, address indexed newOwner);\n    event FarmChanged(address indexed oldFarm, address indexed newFarm);\n\n    modifier onlyOwner() { require(msg.sender == owner, \"NOT_OWNER\"); _; }\n    modifier whenNotPaused() { require(!paused, \"PAUSED\"); _; }\n    modifier nonReentrant() { require(!reentrancyLock, \"REENTRANT\"); reentrancyLock = true; _; reentrancyLock = false; }\n\n    function initialize(address _usdc, address _usdk, address _farm, address _vault) external {\n        require(!initialized, \"ALREADY_INIT\");\n        require(_usdc != address(0) && _usdk != address(0) && _farm != address(0) && _vault != address(0), \"BAD_ADDR\");\n        usdc = IERC20(_usdc);\n        usdk = IUSDK(_usdk);\n        farm = IStableFarm(_farm);\n        vault = IStableVault(_vault);\n        owner = msg.sender;\n        initialized = true;\n    }\n\n    function setOwner(address _owner) external onlyOwner {\n        require(_owner != address(0), \"BAD_OWNER\");\n        emit OwnerChanged(owner, _owner);\n        owner = _owner;\n    }\n\n    function pause() external onlyOwner { paused = true; emit Paused(msg.sender); }\n    function unpause() external onlyOwner { paused = false; emit Unpaused(msg.sender); }\n\n    // Convert USDC (18 decimals) amount to USDK (6 decimals)\n    function _toUSDK(uint256 usdcAmount) internal pure returns (uint256) {\n        // assumes USDC=18, USDK=6 -> divide by 1e12\n        return usdcAmount / 1_000_000_000_000;\n    }\n\n    // Deposit USDC -> stake in Farm, mint USDK into vault, mint sUSDK (shares) to user\n    function depositUSDC(uint256 amount) external whenNotPaused nonReentrant {\n        require(initialized, \"NOT_INIT\");\n        require(amount > 0, \"AMOUNT_ZERO\");\n        require(usdc.transferFrom(msg.sender, address(this), amount), \"USDC_XFER_FAIL\");\n        require(usdc.approve(address(farm), amount), \"USDC_APPROVE_FAIL\");\n        farm.stake(amount);\n        // normalize 18-dec USDC to 6-dec USDK\n        uint256 mintAmount = _toUSDK(amount);\n        usdk.mint(address(vault), mintAmount);\n        vault.depositUSDK(mintAmount);\n        vault.mintShares(msg.sender, amount);\n        emit Deposited(msg.sender, amount, amount);\n    }\n\n    // Harvest global rewards: split full reward 5/6 USDK to vault, 1/6 KTG points (accounting off-chain or separate contract)\n    function harvestGlobal() external onlyOwner whenNotPaused nonReentrant {\n        require(initialized, \"NOT_INIT\");\n        farm.compound();\n        uint256 pending = farm.pendingRewards();\n        if (pending == 0) return;\n        uint256 claimed = farm.claim();\n        uint256 reward = claimed;\n        if (reward == 0) reward = pending;\n        // normalize reward from USDC(18) to USDK(6)\n        uint256 rewardUsdkUnits = _toUSDK(reward);\n        uint256 usdkPart = (rewardUsdkUnits * 5) / 6; // 83.33%\n        uint256 ktgPart = rewardUsdkUnits - usdkPart;  // 16.66%\n        usdk.mint(address(vault), usdkPart);\n        vault.depositUSDK(usdkPart);\n        emit Harvested(rewardUsdkUnits, usdkPart, ktgPart);\n    }\n\n    // Compound: claim rewards and restake into Farm\n    function compoundGlobal() external whenNotPaused nonReentrant {\n        require(initialized, \"NOT_INIT\");\n        // get pending rewards\n        uint256 pending = farm.pendingRewards();\n        if (pending == 0) {\n            emit Compounded(block.timestamp, 0);\n            return;\n        }\n        // claim rewards (USDC) to this controller\n        uint256 claimed = farm.claim();\n        require(claimed > 0, \"NO_CLAIM\");\n        // safe approve pattern (handles strict tokens)\n        // reset allowance if needed\n        usdc.approve(address(farm), 0);\n        // set allowance to claimed\n        require(usdc.approve(address(farm), claimed), \"APPROVE_FAIL\");\n        // restake rewards\n        farm.stake(claimed);\n        emit Compounded(block.timestamp, claimed);\n    }\n\n    // Withdraw by burning sUSDK shares; user receives USDK from the Vault (normalized 18->6)\n    function withdrawShares(uint256 shares) external whenNotPaused nonReentrant {\n        require(initialized, \"NOT_INIT\");\n        require(shares > 0, \"AMOUNT_ZERO\");\n        vault.burnShares(msg.sender, shares);\n        // transfer normalized USDK from Vault to user instead of minting\n        vault.redeemUSDK(msg.sender, shares);\n        emit Withdrawn(msg.sender, shares, shares);\n    }\n\n    function setFarm(address _farm) external onlyOwner {\n        require(_farm != address(0), \"BAD_FARM\");\n        emit FarmChanged(address(farm), _farm);\n        farm = IStableFarm(_farm);\n    }\n\n    function setAllowance(uint256 amount) external onlyOwner whenNotPaused {\n        // safe approve pattern\n        usdc.approve(address(farm), 0);\n        require(usdc.approve(address(farm), amount), \"APPROVE_FAIL\");\n    }\n}\n"}},"settings":{"optimizer":{"enabled":true,"runs":200},"outputSelection":{"*":{"":["ast"],"*":["abi","metadata","devdoc","userdoc","storageLayout","evm.legacyAssembly","evm.bytecode","evm.deployedBytecode","evm.methodIdentifiers","evm.gasEstimates","evm.assembly"]}},"remappings":[],"evmVersion":"shanghai"}}
